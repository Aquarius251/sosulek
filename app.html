<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>V√°noƒçn√≠ p≈ôekvapen√≠ ‚Äì Tajenka</title>
  <meta name="theme-color" content="#0b2e1b" />
  <style>
    :root{
      --bg1:#071b12;
      --bg2:#0b2e1b;
      --card:#0e3a22cc;
      --card2:#0e3a22;
      --text:#f6fff8;
      --muted:#cfe9d8;
      --accent:#ffcc66;
      --good:#38d67a;
      --bad:#ff5d5d;
      --line:#1c6b3d;
      --shadow: 0 12px 35px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 26px;
      --cell: 32px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: SF pro, -apple-system, Inter, Segoe UI, ui-sans-serif, system-ui,  Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 0%, #145c37 0%, transparent 65%),
        radial-gradient(900px 600px at 90% 10%, #0d4b2c 0%, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* falling snow */
    .snow{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image:
        radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,.85) 50%, transparent 55%),
        radial-gradient(1.5px 1.5px at 120px 140px, rgba(255,255,255,.65) 50%, transparent 55%),
        radial-gradient(2px 2px at 220px 80px, rgba(255,255,255,.75) 50%, transparent 55%),
        radial-gradient(1px 1px at 320px 180px, rgba(255,255,255,.55) 50%, transparent 55%),
        radial-gradient(2px 2px at 420px 50px, rgba(255,255,255,.7) 50%, transparent 55%);
      background-size: 500px 250px;
      animation:snow 12s linear infinite;
      opacity:.55;
      filter: blur(.2px);
    }
    @keyframes snow{from{transform:translateY(-60px)}to{transform:translateY(260px)}}

    .wrap{
      position:relative;
      z-index:1;
      max-width: 520px;
      margin: 0 auto;
      padding: 8px 0px 0px;
    }

    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 10px 0px 16px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      font-size: 40px;
    }

    h1{margin:0; font-size:16px; line-height:1.2}
    .sub{margin:0; font-size:12px; color:var(--muted); opacity:.95}

    .pill{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      padding:8px 10px;
      border-radius: 999px;
      font-size:12px;
      color:var(--muted);
      display:flex; align-items:center; gap:8px;
      margin-right:12px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardTop{
      display:none!important;
      padding: 14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), transparent);
    }
    .levelTitle{font-weight:700; letter-spacing:.2px}
    .hint{font-size:12px; color:var(--muted)}

    .board{
      padding: 10px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .flag{
      width: 38px;
      flex: 0 0 38px;
      display:grid;
      place-items:center;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
    }
    .flag svg{width:34px;height:24px;border-radius:6px;overflow:hidden;border:1px solid rgba(255,255,255,.18)}

    .cell.key{
      background: rgba(255, 204, 102, .28) !important;
      border-color: rgba(255, 204, 102, .75) !important;
      box-shadow: 0 0 0 3px rgba(255,204,102,.12) inset, 0 8px 16px rgba(0,0,0,.18);
    }
    .cell.key.solved{
      background: rgba(56, 214, 122, .22) !important;
      border-color: rgba(56,214,122,.75) !important;
      box-shadow: 0 0 0 3px rgba(56,214,122,.12) inset, 0 8px 16px rgba(0,0,0,.18);
    }

    .cells{
      display:flex;
      gap:4px;
      flex-wrap:nowrap;
      align-items:center;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .cells::-webkit-scrollbar{display:none}

    .cell{
      width: var(--cell);
      height: var(--cell);
      flex: 0 0 var(--cell);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.16);
      display:grid;
      place-items:center;
      position:relative;
    }

    input.letter{
      width: 100%;
      height: 100%;
      border:0;
      background: transparent;
      outline: none;
      color: var(--text);
      text-transform: uppercase;
      font-weight: 800;
      font-size: 16px;
      text-align: center;
      letter-spacing: 0.5px;
      caret-color: transparent;
    }

    .cell.space{
      background: transparent;
      border-color: transparent;
      width: 14px;
    }

    .rowStatus{
      margin-left:auto;
      font-size: 12px;
      color: var(--muted);
      opacity:.9;
      width: 8px;
      text-align:right;
    }

    .ok{color: var(--good); font-weight:800}
    .no{color: var(--bad); font-weight:800}

    .controls{
      display:flex;
      gap:10px;
      padding: 12px 14px 14px;
      flex-direction: column;
    }

    button{
      border:0;
      border-radius: 16px;
      padding: 12px 12px;
      font-weight: 800;
      color: #0b2e1b;
      background: linear-gradient(180deg, #ffe3a3, #ffcc66);
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
      flex:1;
      min-width: 140px;
      cursor:pointer;
    }
    button.secondary{
      background: rgba(255,255,255,.10);
      color: var(--text);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: none;
    }

    /* FIX: disabled buttons should not disappear */
    button:disabled{
      opacity:.35;
      filter: grayscale(.25);
      cursor: not-allowed;
      pointer-events:none;
    }

    .secretBox{
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.18));
    }

    .secretTitle{font-weight:900; letter-spacing:.3px; margin:0 0 8px}
    .secretGrid{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .secretChar{
      width: 34px; height: 40px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      display:grid; place-items:center;
      font-weight: 900;
      letter-spacing:.4px;
    }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.18);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text);
      box-shadow: var(--shadow);
      z-index: 5;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-4px)}

    .footer{
      margin-top: 14px;
      padding: 12px 10px 0;
      color: rgba(246,255,248,.85);
      font-size: 12px;
      text-align:center;
      opacity:.9;
    }
    a{color:var(--accent)}

    /* FINISH OVERLAY (full screen) */
    .finishOverlay{
      position:fixed;
      inset:0;
      z-index:10;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px 14px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }

    .finishCard{
      width: 100%;
      max-width: 560px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      border-radius: 22px;
      overflow:hidden;
    }

    .finishTop{
      padding: 16px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), transparent);
    }

    .finishTitle{font-weight:900; letter-spacing:.3px}
    .finishHint{font-size:12px; color:var(--muted); margin-top:4px}

    .finishInner{
      padding:16px 14px 14px;
    }

    .finishBox{
      border-radius:18px;
      background:rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.12);
      padding:14px;
    }

    .finishBtns{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* small screens */
    @media (max-width: 360px){
      :root{ --cell: 30px; }
      .flag{font-size:22px}
      button{min-width: 120px;}
    }
  </style>
</head>
<body>
  <div class="snow" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>üéÑ</span></div>
        <div>
          <h1>V√°noƒçn√≠ p≈ôekvapen√≠</h1>
          <p class="sub">H√°dej st√°ty dle vlajek (anglicky) a&nbsp;odhal um√≠stƒõn√≠ d√°rku</p>
        </div>
      </div>
      <div class="pill" id="progressPill">Level <b id="levelNo">1</b>/&nbsp;5</div>
    </header>

    <main class="card" id="gameCard">
      <div class="cardTop">
        <div>
          <div class="levelTitle" id="levelTitle">Level 1</div>
        </div>
        <div class="pill">‚è≥ <span id="solvedCount">0</span>/<span id="totalRows">0</span></div>
      </div>

      <section class="board" id="board"></section>

      <section class="secretBox" id="secretBox">
        <p class="secretTitle">Tajenka</p>
        <div class="secretGrid" id="secretGrid"></div>
        <div class="hint" style="margin-top:10px" id="secretHint">Tajenka se odkryje po vy≈ôe≈°en√≠ v≈°ech ≈ô√°dk≈Ø.</div>
      </section>
    </main>

    <div class="footer" id="footer"></div>
  </div>

  <section class="controls">
    <button class="secondary" id="checkBtn">‚úÖ Zkontrolovat</button>
    <button id="revealBtn" disabled>üîÄ P≈ôerovnat tajenku</button>
    <button id="nextBtn" disabled>Dal≈°√≠ level ‚Ä∫</button>
  </section>

  <!-- FULLSCREEN FINISH OVERLAY -->
  <div class="finishOverlay" id="finishOverlay" hidden>
    <div class="finishCard">
      <div class="finishTop">
        <div>
          <div class="finishTitle">üéÖ Hotovo!</div>
          <div class="finishHint">Jsi ≈°ikovn√Ω Sos≈Ølek. Vy≈ôe≈°ila jsi v≈°ech 5&nbsp;level≈Ø. </div>
        </div>
        <div class="pill">üèÜ </div>
      </div>

      <div class="finishInner">
        <div class="finishBox">
          <div style="font-weight:900; letter-spacing:.3px; margin-bottom:6px">üìÑ St√°hnout LEGO n√°vod</div>

          <div class="finishBtns">
            <a id="pdfLink2" href="#" target="_blank" style="flex:1; min-width:200px; text-decoration:none">
              <button style="width:100%">‚¨áÔ∏è Google Drive</button>
            </a>
            <button class="secondary" id="resetBtn2" style="flex:1; min-width:160px">üîÅ Hr√°t znovu</button>
          </div>
        </div>
      </div>

      <div class="footer" style="padding-bottom:48px;">üéÅ D√≠ky za hru!</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // =========================
  // DATA (m≈Ø≈æe≈° pozdƒõji upravit)
  // =========================
  const LEVELS = [
    {
      name: "Level 1",
      secret: "NYHCUK",
      rows: [
        { flag: "IR", answer: "IRAN", keyIndex: 3 },
        { flag: "YE", answer: "YEMEN", keyIndex: 0 },
        { flag: "BS", answer: "BAHAMAS", keyIndex: 2 },
        { flag: "FR", answer: "FRANCE", keyIndex: 4 },
        { flag: "KW", answer: "KUWAIT", keyIndex: 1 },
        { flag: "KR", answer: "KOREA", keyIndex: 0 }
      ]
    },
    {
      name: "Level 2",
      secret: "ANLEPUOK",
      rows: [
        { flag: "AM", answer: "ARMENIA", keyIndex: 0 },
        { flag: "DM", answer: "DOMINICA", keyIndex: 4 },
        { flag: "FI", answer: "FINLAND", keyIndex: 3 },
        { flag: "GG", answer: "GUERNSEY", keyIndex: 2 },
        { flag: "PE", answer: "PERU", keyIndex: 0 },
        { flag: "TN", answer: "TUNISIA", keyIndex: 1 },
        { flag: "OM", answer: "OMAN", keyIndex: 0 },
        { flag: "HK", answer: "HONGKONG", keyIndex: 4 }
      ]
    },
    {
      name: "Level 3",
      secret: "LETSOP",
      rows: [
        { flag: "SN", answer: "SENEGAL", keyIndex: 6 },
        { flag: "CL", answer: "CHILE", keyIndex: 4 },
        { flag: "TZ", answer: "TANZANIA", keyIndex: 0 },
        { flag: "RU", answer: "RUSSIA", keyIndex: 3 },
        { flag: "NO", answer: "NORWAY", keyIndex: 1 },
        { flag: "JP", answer: "JAPAN", keyIndex: 2 },
      ]
    },
    {
      name: "Level 4",
      secret: "NOKLAB",
      rows: [
        { flag: "KE", answer: "KENYA", keyIndex: 2 },
        { flag: "XK", answer: "KOSOVO", keyIndex: 3 },
        { flag: "DK", answer: "DENMARK", keyIndex: 6 },
        { flag: "LA", answer: "LAOS", keyIndex: 0 },
        { flag: "RS", answer: "SERBIA", keyIndex: 5 },
        { flag: "BE", answer: "BELGIUM", keyIndex: 0 }
      ]
    },
    {
      name: "Level 5",
      secret: "AROMOK",
      rows: [
        { flag: "VN", answer: "VIETNAM", keyIndex: 5 },
        { flag: "SY", answer: "SYRIA", keyIndex: 2 },
        { flag: "TO", answer: "TONGA", keyIndex: 1 },
        { flag: "SO", answer: "SOMALIA", keyIndex: 2 },
        { flag: "MD", answer: "MOLDOVA", keyIndex: 1 },
        { flag: "PK", answer: "PAKISTAN", keyIndex: 2 }
      ]
    }
  ];

  // =========================
  // STATE
  // =========================
  let levelIndex = 0;
  let solvedRows = new Set();
  let reversedRevealed = false;

  const els = {
    board: document.getElementById('board'),
    levelNo: document.getElementById('levelNo'),
    levelTitle: document.getElementById('levelTitle'),
    solvedCount: document.getElementById('solvedCount'),
    totalRows: document.getElementById('totalRows'),
    secretGrid: document.getElementById('secretGrid'),
    secretHint: document.getElementById('secretHint'),
    checkBtn: document.getElementById('checkBtn'),
    revealBtn: document.getElementById('revealBtn'),
    nextBtn: document.getElementById('nextBtn'),
    footer: document.getElementById('footer'),
    toast: document.getElementById('toast'),
    progressPill: document.getElementById('progressPill'),
  };

  // =========================
  // HELPERS
  // =========================
  const normalize = (s) => (s||"")
    .toUpperCase()
    .normalize('NFD')
    .replace(/\p{Diacritic}/gu,'')
    .replace(/[^A-Z ]/g,'')
    .replace(/\s+/g,' ')
    .trim();

  function toast(msg){
    els.toast.textContent = msg;
    els.toast.classList.add('show');
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>els.toast.classList.remove('show'), 1800);
  }

  function saveProgress(){
    const payload = {
      levelIndex,
      solved: Array.from(solvedRows),
      reversedRevealed,
      inputs: grabAllInputs()
    };
    localStorage.setItem('xmas_tajenka_progress', JSON.stringify(payload));
  }

  function loadProgress(){
    try{
      const raw = localStorage.getItem('xmas_tajenka_progress');
      if(!raw) return;
      const p = JSON.parse(raw);
      if(typeof p.levelIndex === 'number') levelIndex = Math.max(0, Math.min(LEVELS.length-1, p.levelIndex));
      solvedRows = new Set(Array.isArray(p.solved) ? p.solved : []);
      reversedRevealed = !!p.reversedRevealed;
    }catch(e){}
  }

  function clearProgress(){
    localStorage.removeItem('xmas_tajenka_progress');
  }

  function grabAllInputs(){
    const data = {};
    document.querySelectorAll('[data-row]').forEach(rowEl=>{
      const r = rowEl.getAttribute('data-row');
      const letters = Array.from(rowEl.querySelectorAll('input.letter')).map(i=>i.value||"");
      data[r] = letters;
    });
    return data;
  }

  function restoreInputs(saved){
    if(!saved) return;
    Object.entries(saved).forEach(([r, letters])=>{
      const rowEl = document.querySelector(`[data-row="${r}"]`);
      if(!rowEl) return;
      const ins = Array.from(rowEl.querySelectorAll('input.letter'));
      ins.forEach((i, idx)=>{ if(letters[idx] != null) i.value = letters[idx]; });
    });
  }

  function isLevelSolved(){
    const level = LEVELS[levelIndex];
    return solvedRows.size >= level.rows.length;
  }

  function computeSecretString(reversed=true){
    const level = LEVELS[levelIndex];
    const secretLen = level.secret.length;
    let out = [];
    for(let i=0; i<secretLen; i++){
      const row = level.rows[i];
      if(!row) { out.push('‚Ä¢'); continue; }
      const ans = normalize(row.answer).replace(/ /g,'');
      const idx = Number.isFinite(row.keyIndex) ? row.keyIndex : i;
      const ch = ans[idx] || '‚Ä¢';
      out.push(ch);
    }
    const str = out.join('');
    return reversed ? str : str.split('').reverse().join('');
  }

  function renderSecret(reordered=false){
    if(!isLevelSolved()){
      els.secretGrid.innerHTML = '';
      els.secretHint.textContent = 'Tajenka se odkryje po vy≈ôe≈°en√≠ v≈°ech ≈ô√°dk≈Ø.';
      return;
    }

    els.secretGrid.innerHTML = '';
    const raw = computeSecretString(true);
    const reorderedStr = raw.split('').reverse().join('');
    const display = reordered ? reorderedStr : raw;

    display.split('').forEach(ch=>{
      const d = document.createElement('div');
      d.className = 'secretChar';
      d.textContent = ch;
      els.secretGrid.appendChild(d);
    });

    els.secretHint.textContent = reordered
      ? `üéâ Tajenka je hotov√°!`
      : `‚úÖ Tajenka je odemƒçen√°. Pokud chce≈°, m≈Ø≈æe≈° ji p≈ôerovnat.`;
  }

  // =========================
  // RENDER LEVEL
  // =========================
  function renderLevel(){
    const level = LEVELS[levelIndex];
    els.levelNo.textContent = String(levelIndex+1);
    els.levelTitle.textContent = level.name;
    els.totalRows.textContent = String(level.rows.length);

    els.board.innerHTML = '';

    level.rows.forEach((r, idx)=>{
      const rowEl = document.createElement('div');
      rowEl.className = 'row';
      rowEl.setAttribute('data-row', String(idx));

      const flag = document.createElement('div');
      flag.className = 'flag';
      flag.innerHTML = getFlagImg(r.flag);

      const cells = document.createElement('div');
      cells.className = 'cells';

      const pattern = r.answer; // keep spaces
      let inputIndex = 0;

      for(const ch of pattern){
        if(ch === ' '){
          const sp = document.createElement('div');
          sp.className = 'cell space';
          cells.appendChild(sp);
        } else {
          const c = document.createElement('div');
          c.className = 'cell';

          const keyIdx = Number.isFinite(r.keyIndex) ? r.keyIndex : idx;
          if(inputIndex === keyIdx) c.classList.add('key');

          const input = document.createElement('input');
          input.className = 'letter';
          input.maxLength = 1;
          input.inputMode = 'text';
          input.autocomplete = 'off';
          input.autocapitalize = 'characters';
          input.spellcheck = false;
          input.setAttribute('data-row', String(idx));
          input.setAttribute('data-col', String(inputIndex));

          input.addEventListener('input', (e)=>{
            const v = normalize(e.target.value).replace(/ /g,'');
            e.target.value = (v[0]||'');
            focusNext(input);
            saveProgress();
          });

          input.addEventListener('keydown', (e)=>{
            if(e.key === 'Backspace' && !e.target.value){
              focusPrev(input);
            }
            if(e.key === 'Enter'){
              e.preventDefault();
              checkAll();
            }
          });

          c.appendChild(input);
          cells.appendChild(c);
          inputIndex++;
        }
      }

      const status = document.createElement('div');
      status.className = 'rowStatus';
      status.id = `status-${idx}`;
      status.textContent = '‚Ä¶';

      rowEl.appendChild(flag);
      rowEl.appendChild(cells);
      rowEl.appendChild(status);

      els.board.appendChild(rowEl);
    });

    solvedRows.forEach((idx)=> setRowStatus(idx, true));
    updateSolvedCount();

    renderSecret(reversedRevealed);

    els.revealBtn.disabled = !isLevelSolved();
    els.nextBtn.disabled = !(isLevelSolved() && reversedRevealed);

    // ‚úÖ last level button label
    if(levelIndex === LEVELS.length - 1){
      els.nextBtn.textContent = 'üèÅ Dokonƒçit';
    } else {
      els.nextBtn.textContent = 'Dal≈°√≠ level ‚Ä∫';
    }

    try{
      const raw = localStorage.getItem('xmas_tajenka_progress');
      if(raw){
        const p = JSON.parse(raw);
        if(p && p.levelIndex === levelIndex){
          restoreInputs(p.inputs);
        }
      }
    }catch(e){}

    const first = document.querySelector('input.letter');
    if(first) first.focus();
  }

  function getFlagImg(code){
    const cc = (code || 'xx').toLowerCase();
    return `<img src="https://flagcdn.com/w40/${cc}.png"
                alt="${cc} flag"
                loading="lazy"
                style="width:34px;height:24px;border-radius:6px;border:1px solid rgba(255,255,255,.18);object-fit:cover;">`;
  }

  function focusNext(input){
    const row = input.getAttribute('data-row');
    const col = Number(input.getAttribute('data-col'));
    const next = document.querySelector(`input.letter[data-row="${row}"][data-col="${col+1}"]`);
    if(next) next.focus();
}

  function focusPrev(input){
    const row = input.getAttribute('data-row');
    const col = Number(input.getAttribute('data-col'));
    const prev = document.querySelector(`input.letter[data-row="${row}"][data-col="${col-1}"]`);
    if(prev) prev.focus();
  }

  function setRowStatus(idx, ok){
  const st = document.getElementById(`status-${idx}`);
  if(!st) return;
  st.classList.toggle('ok', ok);
  st.classList.toggle('no', !ok);
  st.textContent = ok ? '‚úÖ' : '‚ùå';
}

  function updateSolvedCount(){
    const level = LEVELS[levelIndex];
    els.solvedCount.textContent = String(Math.min(solvedRows.size, level.rows.length));
  }

  // =========================
  // CHECKING
  // =========================
  function readRowGuess(idx){
    const rowEl = document.querySelector(`[data-row="${idx}"]`);
    if(!rowEl) return '';
    const letters = Array.from(rowEl.querySelectorAll('input.letter')).map(i => (i.value||''));
    const joined = letters.join('');
    return normalize(joined);
  }

  function checkRow(idx){
    const level = LEVELS[levelIndex];
    const ans = normalize(level.rows[idx].answer).replace(/ /g,'');
    const guess = readRowGuess(idx).replace(/ /g,'');

    const ok = ans === guess && guess.length === ans.length;
    const rowEl = document.querySelector(`[data-row="${idx}"]`);


  if(rowEl){
    const keyIdx = Number.isFinite(level.rows[idx].keyIndex) ? level.rows[idx].keyIndex : idx;
    const keyInput = rowEl.querySelector(`input.letter[data-col="${keyIdx}"]`);
    const keyCell = keyInput ? keyInput.closest('.cell') : null;
    if(keyCell) keyCell.classList.toggle('solved', ok);
  }

  if(ok){
    solvedRows.add(String(idx));
    setRowStatus(idx, true);
  } else {
    solvedRows.delete(String(idx));
    setRowStatus(idx, false);
  }
  }

  function checkAll(){
    const level = LEVELS[levelIndex];
    for(let i=0;i<level.rows.length;i++) checkRow(i);
    updateSolvedCount();

    if(isLevelSolved()){
      els.revealBtn.disabled = false;
      toast('üéâ V≈°echny ≈ô√°dky jsou spr√°vnƒõ!');
    } else {
      toast('Zkontrolov√°no. Nƒõco nesed√≠ üôÇ');
    }

    renderSecret(reversedRevealed);
    saveProgress();
  }

  // =========================
  // NAVIGATION
  // =========================
  function goNextLevel(){
    if(levelIndex < LEVELS.length-1){
      levelIndex++;
      solvedRows = new Set();
      reversedRevealed = false;
      saveProgress();
      renderLevel();
      toast('‚û°Ô∏è Dal≈°√≠ level');
    } else {
      showFinish();
    }
  }

  // ‚úÖ FULLSCREEN FINISH
  function showFinish(){
    const overlay = document.getElementById('finishOverlay');
    overlay.hidden = false;

    // hide game UI for cleaner finish
    document.querySelector('.controls').style.display = 'none';
    document.querySelector('.wrap header').style.display = 'none';

    // PDF link
    const a = document.getElementById('pdfLink2');
    a.href = "https://drive.google.com/drive/folders/1Bhlh6bVfRE-ToyG51njDMqImO0YdmZ42?usp=sharing";

    // reset
    document.getElementById('resetBtn2').addEventListener('click', ()=>{
      clearProgress();
      levelIndex = 0;
      solvedRows = new Set();
      reversedRevealed = false;
      location.href = './index.html';
    });
  }

  // =========================
  // EVENTS
  // =========================
  els.checkBtn.addEventListener('click', checkAll);

  els.revealBtn.addEventListener('click', ()=>{
    if(!isLevelSolved()) return;
    reversedRevealed = true;
    renderSecret(true);
    els.nextBtn.disabled = false;
    saveProgress();
    toast('üîÄ Tajenka p≈ôerovn√°na!');
  });

  els.nextBtn.addEventListener('click', ()=>{
    if(!(isLevelSolved() && reversedRevealed)) return;
    goNextLevel();
  });

  // =========================
  // INIT
  // =========================
  loadProgress();
  renderLevel();

</script>
</body>
</html>
